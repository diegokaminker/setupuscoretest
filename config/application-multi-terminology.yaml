# HAPI FHIR JPA Server - US Core 8.0.1 Configuration
# MULTI-TERMINOLOGY: tx (LOINC/SNOMED) + local US Core/HL7 + VSAC FHIR Server
#
# Use: spring.config.import=optional:config/application-multi-terminology.yaml
#   or run with: --spring.profiles.active=multi-terminology (if profile is added)

server:
  port: 8080
  tomcat:
    relaxed-query-chars: "|"

spring:
  main:
    allow-bean-definition-overriding: false
    allow-circular-references: true
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:postgres}:${POSTGRES_PORT:5432}/${POSTGRES_DB:hapi}
    username: ${POSTGRES_USER:admin}
    password: ${POSTGRES_PASSWORD:admin}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      connection-timeout: 60000
      initialization-fail-timeout: 120000
  jpa:
    properties:
      hibernate:
        dialect: ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect
        format_sql: false
        show_sql: false
    hbm2ddl:
      auto: update
  flyway:
    enabled: false

management:
  endpoints:
    web:
      exposure:
        include: "health"
  endpoint:
    health:
      probes:
        enabled: true

# VSAC / UMLS API key for cts.nlm.nih.gov (override with VSAC_UMLS_API_KEY env var)
vsac:
  api_key: ${VSAC_UMLS_API_KEY:}

hapi:
  fhir:
    fhir_version: R4
    openapi_enabled: true

    # -------------------------------------------------------------------------
    # US Core 8.0.1 Implementation Guide
    # -------------------------------------------------------------------------
    install_transitive_ig_dependencies: true
    ips_enabled: true
    implementationguides:
      uscore:
        name: hl7.fhir.us.core
        version: 8.0.1
        reloadExisting: false
        installMode: STORE_AND_INSTALL
      ips:
        name: hl7.fhir.uv.ips
        version: 1.1.0
        reloadExisting: false
        installMode: STORE_AND_INSTALL
      hl7terminology:
        name: hl7.terminology.r4
        version: "5.0.0"
        reloadExisting: false
        installMode: STORE_AND_INSTALL

    # -------------------------------------------------------------------------
    # Terminology: three sources
    # 1. tx.fhir.org  → LOINC and SNOMED
    # 2. Local/IG     → US Core value sets + UCUM, HL7 (from IG + hl7.terminology.r4)
    # 3. VSAC         → VSAC value sets (cts.nlm.nih.gov); may require UMLS API key
    # -------------------------------------------------------------------------
    logical_urls:
      - "http://terminology.hl7.org/*"
      - "https://terminology.hl7.org/*"
      - "http://snomed.info/*"
      - "https://snomed.info/*"
      - "http://unitsofmeasure.org/*"
      - "https://unitsofmeasure.org/*"
      - "http://loinc.org/*"
      - "https://loinc.org/*"
      - "http://hl7.org/fhir/us/core/*"
      - "https://hl7.org/fhir/us/core/*"
      - "http://cts.nlm.nih.gov/fhir/*"
      - "https://cts.nlm.nih.gov/fhir/*"

    # Multiple remote terminology services (order can affect which server is tried first).
    # HAPI routes by CODE SYSTEM. Only LOINC and SNOMED are sent to tx; all other systems
    # used in US Core / VSAC value sets are sent to VSAC (set VSAC_TERMINOLOGY_URL to your proxy).
    # Value set resolution by URL (http://cts.nlm.nih.gov/fhir/ValueSet/...) uses the vsac entry below.
    remote_terminology_service:
      # tx.fhir.org — only LOINC and SNOMED (explicit so they do not go to VSAC)
      tx_loinc:
        system: "http://loinc.org"
        url: "https://tx.fhir.org/r4/"
      tx_snomed:
        system: "http://snomed.info"
        url: "https://tx.fhir.org/r4/"
      # VSAC: value set URLs (ValueSet/$expand, resolve by url)
      vsac:
        system: "http://cts.nlm.nih.gov/fhir"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      # VSAC: code systems used in US Core / VSAC value sets (validate-code routes by code system)
      vsac_cdcrec:
        system: "urn:oid:2.16.840.1.113883.6.238"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_cpt:
        system: "urn:oid:2.16.840.1.113883.3.221.5"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_hcpcs:
        system: "urn:oid:2.16.840.1.113883.6.285"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_icd10cm:
        system: "urn:oid:2.16.840.1.113883.6.90"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_icd10pcs:
        system: "urn:oid:2.16.840.1.113883.6.103"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_nucc:
        system: "urn:oid:2.16.840.1.113883.11.19465"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_rxnorm:
        system: "urn:oid:2.16.840.1.113883.6.88"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}
      vsac_ndc:
        system: "urn:oid:2.16.840.1.113883.6.69"
        url: ${VSAC_TERMINOLOGY_URL:https://cts.nlm.nih.gov/fhir/}

    # Pre-expand value sets for better performance
    pre_expand_value_sets: true
    enable_task_pre_expand_value_sets: true
    pre_expand_value_sets_default_count: 1000
    maximum_expansion_size: 5000

    # Validation (disable response validation if tx/VSAC metadata causes issues)
    validation:
      requests_enabled: false
      responses_enabled: false

    cors:
      allow_Credentials: true
      allowed_origin:
        - "*"

    tester:
      home:
        name: US Core FHIR Server
        server_address: "http://localhost:8023/fhir"
        fhir_version: R4
