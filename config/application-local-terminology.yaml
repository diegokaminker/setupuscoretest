# HAPI FHIR JPA Server - US Core 8.0.1 Configuration
# LOCAL TERMINOLOGY ONLY - NO dependency on tx.fhir.org
# Use with load-terminology.sh after uploading LOINC and SNOMED locally

server:
  port: 8080
  tomcat:
    relaxed-query-chars: "|"

spring:
  main:
    allow-bean-definition-overriding: false
    allow-circular-references: true
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:postgres}:${POSTGRES_PORT:5432}/${POSTGRES_DB:hapi}
    username: ${POSTGRES_USER:admin}
    password: ${POSTGRES_PASSWORD:admin}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      connection-timeout: 60000
      initialization-fail-timeout: 120000

  jpa:
    properties:
      hibernate:
        dialect: ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect
        format_sql: false
        show_sql: false
    hbm2ddl:
      auto: update

  flyway:
    enabled: false

management:
  endpoints:
    web:
      exposure:
        include: "health"
  endpoint:
    health:
      probes:
        enabled: true

hapi:
  fhir:
    fhir_version: R4
    openapi_enabled: true

    # -------------------------------------------------------------------------
    # US Core 8.0.1 Implementation Guide
    # -------------------------------------------------------------------------
    install_transitive_ig_dependencies: true
    ips_enabled: true
    implementationguides:
      uscore:
        name: hl7.fhir.us.core
        version: 8.0.1
        reloadExisting: false
        installMode: STORE_AND_INSTALL
      ips:
        name: hl7.fhir.uv.ips
        version: 1.1.0
        reloadExisting: false
        installMode: STORE_AND_INSTALL
      hl7terminology:
        name: hl7.terminology.r4
        version: "5.0.0"
        reloadExisting: false
        installMode: STORE_AND_INSTALL

    # -------------------------------------------------------------------------
    # LOCAL terminology only - NO remote tx.fhir.org
    # LOINC and SNOMED loaded via load-terminology.sh
    # UCUM and HL7 vocab from hl7.terminology.r4
    # -------------------------------------------------------------------------
    logical_urls:
      - "http://terminology.hl7.org/*"
      - "https://terminology.hl7.org/*"
      - "http://snomed.info/*"
      - "https://snomed.info/*"
      - "http://unitsofmeasure.org/*"
      - "https://unitsofmeasure.org/*"
      - "http://loinc.org/*"
      - "https://loinc.org/*"
      - "http://hl7.org/fhir/us/core/*"
      - "https://hl7.org/fhir/us/core/*"

    # Remote terminology DISABLED - all terminology local
    # remote_terminology_service: removed

    # Pre-expand value sets for better performance
    pre_expand_value_sets: true
    enable_task_pre_expand_value_sets: true
    pre_expand_value_sets_default_count: 1000
    maximum_expansion_size: 5000

    validation:
      requests_enabled: true
      responses_enabled: false   # avoids CapabilityStatement.format MIME validation failure

    cors:
      allow_Credentials: true
      allowed_origin:
        - "*"

    tester:
      home:
        name: US Core FHIR Server
        server_address: "http://localhost:8023/fhir"
        fhir_version: R4
