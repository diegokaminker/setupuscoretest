# HAPI FHIR JPA Server - US Core 8.0.1 Configuration
# REMOTE TERMINOLOGY - Uses tx.fhir.org for LOINC and SNOMED (default)

server:
  port: 8080
  tomcat:
    relaxed-query-chars: "|"

spring:
  main:
    allow-bean-definition-overriding: false
    allow-circular-references: true
  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST:postgres}:${POSTGRES_PORT:5432}/${POSTGRES_DB:hapi}
    username: ${POSTGRES_USER:admin}
    password: ${POSTGRES_PASSWORD:admin}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      connection-timeout: 60000
      initialization-fail-timeout: 120000
  jpa:
    properties:
      hibernate:
        dialect: ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect
        format_sql: false
        show_sql: false
    hbm2ddl:
      auto: update
  flyway:
    enabled: false

management:
  endpoints:
    web:
      exposure:
        include: "health"
  endpoint:
    health:
      probes:
        enabled: true

hapi:
  fhir:
    fhir_version: R4
    openapi_enabled: true

    # -------------------------------------------------------------------------
    # US Core 8.0.1 Implementation Guide
    # https://hl7.org/fhir/us/core/
    # -------------------------------------------------------------------------
    install_transitive_ig_dependencies: true
    implementationguides:
      uscore:
        name: hl7.fhir.us.core
        version: 8.0.1
        reloadExisting: false
        installMode: STORE_AND_INSTALL
      ips:
        name: hl7.fhir.uv.ips
        version: 1.1.0
        reloadExisting: false
        installMode: STORE_AND_INSTALL

    # International Patient Summary - enables Patient/$summary operation
    ips_enabled: true

    # -------------------------------------------------------------------------
    # Terminology: LOINC, SNOMED, UCUM, HL7
    # US Core ValueSets reference these code systems. We use:
    # 1. Remote tx.fhir.org for LOINC and SNOMED (full expansions)
    # 2. hl7.terminology.r4 package loads UCUM, HL7 value sets
    # -------------------------------------------------------------------------
    logical_urls:
      - "http://terminology.hl7.org/*"
      - "https://terminology.hl7.org/*"
      - "http://snomed.info/*"
      - "https://snomed.info/*"
      - "http://unitsofmeasure.org/*"
      - "https://unitsofmeasure.org/*"
      - "http://loinc.org/*"
      - "https://loinc.org/*"
      - "http://hl7.org/fhir/us/core/*"
      - "https://hl7.org/fhir/us/core/*"

    # Remote terminology server for LOINC and SNOMED
    remote_terminology_service:
      all:
        system: "*"
        url: "https://tx.fhir.org/r4/"

    # Pre-expand value sets for better performance
    pre_expand_value_sets: true
    enable_task_pre_expand_value_sets: true
    pre_expand_value_sets_default_count: 1000
    maximum_expansion_size: 5000

    # Validation
    # responses_enabled: false - tx.fhir.org rejects IANA MIME codes (xml, json, etc.)
    # in CapabilityStatement.format, causing metadata to return OperationOutcome instead
    validation:
      requests_enabled: false
      responses_enabled: false

    # CORS for web clients
    cors:
      allow_Credentials: true
      allowed_origin:
        - "*"

    # Tester UI
    tester:
      home:
        name: US Core FHIR Server
        server_address: "http://localhost:8023/fhir"
        fhir_version: R4
